<!DOCTYPE html>
<html>
  <head>
    <title>Voron demo for KievII</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="../../graphic_elements/Element.js"></script>
    <script type="text/javascript" src="../../graphic_elements/UI.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Knob.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Background.js"></script>
    <script type="text/javascript" src="../../graphic_elements/wrappers/CanvasDraw.js"></script>
  </head>
  <body>
    <canvas id="plugin" width="800" height="800"></canvas>
    <script type="text/javascript">
        // This should fix "console not defined" problem.
        if (typeof console=="undefined"){console={log:function(A){var B=false;if(B){alert(A)}}}}
        var ui;

        /* GENERAL PURPOSE FUNCTIONS */

        // Object clone; see http://my.opera.com/GreyWyvern/blog/show.dml/1725165
        Object.prototype.clone = function() {
            var newObj = (this instanceof Array) ? [] : {};
            for (i in this) {
                if (i == 'clone') continue;
                if (this[i] && typeof this[i] == "object") {
                    newObj[i] = this[i].clone();
                } else newObj[i] = this[i];
            }
            return newObj;
        };

        /* END OF GENERAL PURPOSE FUNCTIONS */

        /* CONTEXT INIT */

        var plugin_canvas = document.getElementById("plugin"),
            plugin_context = plugin_canvas.getContext("2d");

        ui = new UI (plugin_canvas.offsetTop, plugin_canvas.offsetTop);

        // This crap should be automatized.
        document.addEventListener("mousedown", ui.onMouseDownFunc(), true);
        document.addEventListener("mouseup", ui.onMouseUpFunc(), true);
        document.addEventListener("mousemove", ui.onMouseMoveFunc(), true);

        var imageDisplayer = new CanvasDrawImage (plugin_context);

        var loadCallback = loadingManager();
        /* END OF CONTEXT INIT */


        /* BACKGROUND INIT */

        var bgArgs = {
            image: "./images/Voron_bg1.png",
            onComplete: loadCallback
        };

        var gui = new Background("background", [0,0], bgArgs);

        /* END OF BACKGROUND INIT */

        /* KNOB INIT */

        //Generate knob image names
        var MAX_KNOB_IMAGE_NUM = 60,
            i = 0,
            prefix = "",
            knobImgArray = [],
            knobArgs,
            knobImgLocation = "./images/BigKnob/" ;

        for (i = 0; i <= MAX_KNOB_IMAGE_NUM; i++) {
            prefix = "";
            if (i < 10) {
                prefix = "0";
            }
            knobImgArray[i] = knobImgLocation + "BigKnob" + prefix + i + ".png";
        }

        // Shared arguments to the constructor
        knobArgs = {
            images : knobImgArray,
            sensivity : 5000,
            onComplete: loadCallback
        };

        // Create the knob objects.

        // PITCH KNOB
        var pitchArgs = knobArgs.clone();
        pitchArgs.onValueSet = pitchCallback();
        var pitchKnob = new Knob("pitchKnob", [39, 120], pitchArgs);

        // FREQ KNOB
        var freqArgs = knobArgs.clone();
        freqArgs.onValueSet = freqCallback();
        var freqKnob = new Knob("freqKnob", [240, 120], freqArgs);

        // Q KNOB
        var qArgs = knobArgs.clone();
        qArgs.onValueSet = qCallback();
        var qKnob = new Knob("qKnob", [395, 120], qArgs);

        /* END OF KNOB INIT */

        /* KEEP ON */
        
        function keepON () {
            ui.addElement(gui, imageDisplayer);
            ui.addElement(pitchKnob, imageDisplayer);
            ui.addElement(freqKnob, imageDisplayer);
            ui.addElement(qKnob, imageDisplayer);
            // TODO Something like ui.refresh() would be more appropriate, I guess.
            gui.refresh();
            // TODO if drawClass is undefined, just exit. This should be in the
            // initialize section, not here. keepON should do a ui.refresh() to
            // repaint everything (in order).
            pitchKnob.setValue("knobvalue", 0.5);
            freqKnob.setValue("knobvalue", 1);
            // TODO qKnob.setValue("knobvalue", 0) fails (does not display image)
            // because the initial value is 0 (why?). with ui.refresh() this does
            // not happen.
            // Quick-fixed setting default knob value to NaN.
            qKnob.setValue("knobvalue", 0);
        }

        /* --END */

        /*** CALLBACKS ***/

        /* LOADING MANAGER */

        function loadingManager (elementName) {
            // Closure persistent variables.
            var that = this,
                loadStatus = {pitchKnob: false, freqKnob: false, qKnob: false, background: false};

                // Actual callback
                return function (elementName) {
                    console.log (elementName, " called back to say everything is loaded.");

                    // Update the element status
                    if (loadStatus[elementName] !== undefined) {
                        loadStatus[elementName] = true;
                    }

                    // Check if every registered element is complete.
                    for (var element in loadStatus) {
                        if (loadStatus.hasOwnProperty(element)) {
                            if (loadStatus[element] !== true) {
                                console.log ("status of element ", element, " is not true: ", loadStatus[element]);
                                return;
                            }
                        }
                    }
                    console.log ("Everything loaded, time to keep on!");
                    that.keepON();
                }

        }
        /* END OF LOADING MANAGER */

        /* KNOB CALLBACKS */

        function pitchCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("pitch callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        function freqCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("freq callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        function qCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("q callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        /* END OF KNOB CALLBACKS */

    </script>
  </body>
</html>
