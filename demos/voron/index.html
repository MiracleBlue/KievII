<!DOCTYPE html>
<html>
  <head>
    <title>Voron demo for KievII</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="../../graphic_elements/Element.js"></script>
    <script type="text/javascript" src="../../graphic_elements/UI.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Knob.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Background.js"></script>
    <script type="text/javascript" src="../../graphic_elements/wrappers/CanvasDraw.js"></script>
  </head>
  <body>
    <canvas id="plugin" width="800" height="800"></canvas>
    <script type="text/javascript">
        // This should fix "console not defined" problem.
        if (typeof console=="undefined"){console={log:function(A){var B=false;if(B){alert(A)}}}}
        var ui;

        /* GENERAL PURPOSE FUNCTIONS */

        // Object clone; see http://my.opera.com/GreyWyvern/blog/show.dml/1725165
        Object.prototype.clone = function() {
            var newObj = (this instanceof Array) ? [] : {};
            for (i in this) {
                if (i == 'clone') continue;
                if (this[i] && typeof this[i] == "object") {
                    newObj[i] = this[i].clone();
                } else newObj[i] = this[i];
            }
            return newObj;
        };

        /* END OF GENERAL PURPOSE FUNCTIONS */

        /* CONTEXT INIT */

        var plugin_canvas = document.getElementById("plugin"),
            plugin_context = plugin_canvas.getContext("2d");

        ui = new UI (plugin_canvas.offsetTop, plugin_canvas.offsetTop);

        // This crap should be automatized.
        document.addEventListener("mousedown", ui.onMouseDownFunc(), true);
        document.addEventListener("mouseup", ui.onMouseUpFunc(), true);
        document.addEventListener("mousemove", ui.onMouseMoveFunc(), true);

        var imageDisplayer = new CanvasDrawImage (plugin_context);

        /* END OF CONTEXT INIT */


        /* BACKGROUND INIT */

        var bgArgs = {
            image: "./images/Voron_bg1.png"
        };

        var gui = new Background("BackgroundGUI", [0,0], bgArgs);

        /* END OF BACKGROUND INIT */

        /* KNOB INIT */

        //Generate knob image names
        var MAX_KNOB_IMAGE_NUM = 60,
            i = 0,
            prefix = "",
            knobImgArray = [],
            knobArgs,
            knobImgLocation = "./images/BigKnob/" ;

        for (i = 0; i <= MAX_KNOB_IMAGE_NUM; i++) {
            prefix = "";
            if (i < 10) {
                prefix = "0";
            }
            knobImgArray[i] = knobImgLocation + "BigKnob" + prefix + i + ".png";
        }

        // Shared arguments to the constructor
        knobArgs = {
            images : knobImgArray,
            sensivity : 5000
        };

        // Create the three knob objects

        // PITCH KNOB
        var pitchArgs = knobArgs.clone();
        // Callback
        pitchArgs.onValueSet = function () {
            var that = this;
            return function (slot, value) {
                console.log ("onValueSet for Pitch callback: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }();
        var pitchKnob = new Knob("pitchKnob", [39, 120], pitchArgs);
        pitchKnob.setClickable(true);

        // FREQ KNOB
        var freqArgs = knobArgs.clone();
        // Callback
        freqArgs.onValueSet = function () {
            var that = this;
            return function (slot, value) {
                console.log ("onValueSet for Freq callback: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }();
        var freqKnob = new Knob("freqKnob", [240, 120], freqArgs);
        freqKnob.setClickable(true);

        // Q KNOB
        var qArgs = knobArgs.clone();
        // Callback
        qArgs.onValueSet = function () {
            var that = this;
            return function (slot, value) {
                console.log ("onValueSet for Q callback: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }();
        var qKnob = new Knob("qKnob", [395, 120], qArgs);
        qKnob.setClickable(true);

        /* END OF KNOB INIT */

        /* LOADER */

        var knob_complete,
            bg_complete;

        setTimeout(loader, 100);

        function loader () {
            console.log("Executing Initializer");

            knob_complete = true;
            if ((pitchKnob.isComplete() === false) || (freqKnob.isComplete() === false) || (qKnob.isComplete() === false)) {
                console.log("Knobs are not complete.");
                knob_complete = false;
            }
            else {
                console.log("Knobs not complete.");
            }

            bg_complete = gui.isComplete();
            console.log("Background completeness: ", bg_complete);

            if ((knob_complete === true) && (bg_complete === true)) {
                console.log ("Everything complete. Keeping on");
                keepON();
            }

            else {
                console.log ("Not Everything is complete. Setting another timeout");
                setTimeout(loader, 100);
             }
         }

        /* END OF LOADER */

        /* KEEP ON */
        
        function keepON () {
            ui.addElement(gui, imageDisplayer);
            ui.addElement(pitchKnob, imageDisplayer);
            ui.addElement(freqKnob, imageDisplayer);
            ui.addElement(qKnob, imageDisplayer);
            // TODO Something like ui.refresh() would be more appropriate, I guess.
            gui.refresh();
            // TODO if drawClass is undefined, just exit. This should be in the
            // initialize section, not here. keepON should do a ui.refresh() to
            // repaint everything (in order).
            pitchKnob.setValue("knobvalue", 0.5);
            freqKnob.setValue("knobvalue", 1);
            // TODO qKnob.setValue("knobvalue", 0) fails (does not display image)
            // because the initial value is 0 (why?). with ui.refresh() this does
            // not happen.
            // Quick-fixed setting default knob value to NaN.
            qKnob.setValue("knobvalue", 0);
        }

        /* END KEEP ON */

    </script>
  </body>
</html>
