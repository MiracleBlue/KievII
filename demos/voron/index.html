<!DOCTYPE html>
<html>
  <head>
    <title>Voron demo for KievII</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="http://github.com/notmasteryet/audiodata/raw/master/audiodata.js"></script>
    <script src="https://github.com/corbanbrook/dsp.js/raw/master/dsp.js"></script>
    <script src="../../dsp/pitchshift.js"></script>
    <script src="../../audio/ADShifterFilter.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Element.js"></script>
    <script type="text/javascript" src="../../graphic_elements/UI.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Knob.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Slider.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Button.js"></script>
    <script type="text/javascript" src="../../graphic_elements/Background.js"></script>
    <script type="text/javascript" src="../../graphic_elements/wrappers/CanvasDraw.js"></script>
  </head>
  <body>
    <audio id="a1" src="../../audio/sound_files/german_numbers.ogg" controls></audio>
    <canvas id="plugin" width="800" height="800"></canvas>
    <script type="text/javascript">
        // This should fix "console not defined" problem.
        if (typeof console=="undefined"){console={log:function(A){var B=false;if(B){alert(A)}}}}
        var ui;

        /* GENERAL PURPOSE FUNCTIONS */

        // Object clone; see http://my.opera.com/GreyWyvern/blog/show.dml/1725165
        Object.prototype.clone = function() {
            var newObj = (this instanceof Array) ? [] : {};
            for (i in this) {
                if (i == 'clone') continue;
                if (this[i] && typeof this[i] == "object") {
                    newObj[i] = this[i].clone();
                } else newObj[i] = this[i];
            }
            return newObj;
        };

        /* END OF GENERAL PURPOSE FUNCTIONS */

        /* CONTEXT INIT */

        var plugin_canvas = document.getElementById("plugin"),
            plugin_context = plugin_canvas.getContext("2d");

        ui = new UI (plugin_canvas);

        var imageDisplayer = new CanvasDrawImage (plugin_context);
        var freqKnobImageDisplayer = new CanvasDrawImage (plugin_context);
        var qKnobImageDisplayer = new CanvasDrawImage (plugin_context);
        var pitchKnobImageDisplayer = new CanvasDrawImage (plugin_context);
        var volImageDisplayer = new CanvasDrawImage (plugin_context);
        var switchImageDisplayer = new CanvasDrawImage (plugin_context);

        var loadCallback = loadingManager();
        /* END OF CONTEXT INIT */


        /* BACKGROUND INIT */

        var bgArgs = {
            image: "./images/Voron_bg1.png",
            onComplete: loadCallback
        };

        var gui = new Background("background", [0,0], bgArgs);

        /* END OF BACKGROUND INIT */

        /* KNOB INIT */

        //Generate knob image names
        var MAX_KNOB_IMAGE_NUM = 60,
            i = 0,
            prefix = "",
            knobImgArray = [],
            knobArgs,
            volSliderArgs,
            knobImgLocation = "./images/BigKnob/" ;

        for (i = 0; i <= MAX_KNOB_IMAGE_NUM; i++) {
            prefix = "";
            if (i < 10) {
                prefix = "0";
            }
            knobImgArray[i] = knobImgLocation + "BigKnob" + prefix + i + ".png";
        }

        // Shared arguments to the Knob constructor.
        knobArgs = {
            images : knobImgArray,
            sensivity : 5000,
            onComplete: loadCallback,
            preserveBg: true
        };

        // Create the knob objects.

        // PITCH KNOB
        var pitchArgs = knobArgs.clone();
        pitchArgs.onValueSet = pitchCallback();
        var pitchKnob = new Knob("pitchKnob", [67, 150], pitchArgs);

        // FREQ KNOB
        var freqArgs = knobArgs.clone();
        freqArgs.onValueSet = freqCallback();
        var freqKnob = new Knob("freqKnob", [268, 150], freqArgs);

        // Q KNOB
        var qArgs = knobArgs.clone();
        qArgs.onValueSet = qCallback();
        var qKnob = new Knob("qKnob", [421, 150], qArgs);

        /* END OF KNOB INIT */

        /* FADER INIT */

        //VOL FADER
        volSliderArgs = {
            sliderImg:"./images/Fader/slider_slot.png", knobImg:"./images/Fader/slider_handle.png",
            type:"vertical",
            onComplete: loadCallback
        };

        volSliderArgs.onValueSet = volCallback();
        var volSlider = new Slider("volSlider", [646, 136], volSliderArgs);

        /* END OF FADER INIT */

        /* SWITCHES INIT */

        // This time, we use an single callback for all switch buttons.
        var switchCallbackManager = switchCallback();

        // Shared arguments to the Button constructor.
        switchArgs = {
            images : ["./images/Switch/SwitchLeft.png","./images/Switch/SwitchRight.png"],
            onComplete: loadCallback,
            onValueSet: switchCallbackManager
        };

        // Create the switch objects TODO the x,y values are not coherent.
        var pitchOnSwitch = new Button("pitchOnSwitch", [89,107], switchArgs);
        var pitchDiscSwitch = new Button("pitchDiscSwitch", [89,339], switchArgs);
        var freqSwitch = new Button("freqSwitch", [365,107], switchArgs);
        var invertSwitch = new Button("invertSwitch", [638,415], switchArgs);

        /* END OF SWITCHES INIT */

        /* KEEP ON */
        
        function keepON () {

            audioInit();

            // Here we add the elements to the UI, optionally add
            // connections between them and set the initial values.

            ui.addElement(gui, imageDisplayer);
            ui.addElement(pitchKnob, pitchKnobImageDisplayer);
            ui.addElement(freqKnob, freqKnobImageDisplayer);
            ui.addElement(qKnob, qKnobImageDisplayer);
            ui.addElement(volSlider, volImageDisplayer);
            ui.addElement(pitchOnSwitch, switchImageDisplayer);
            ui.addElement(pitchDiscSwitch, switchImageDisplayer);
            ui.addElement(freqSwitch, switchImageDisplayer);
            ui.addElement(invertSwitch, switchImageDisplayer);

            // TODO Something like ui.refresh() would be more appropriate, I guess.
            gui.refresh();

            // TODO if drawClass is undefined, just exit. This should be in the
            // initialize section, not here. keepON should do a ui.refresh() to
            // repaint everything (in order).
            pitchKnob.setValue("knobvalue", 0.5);
            freqKnob.setValue("knobvalue", 1);
            // TODO qKnob.setValue("knobvalue", 0) fails (does not display image)
            // because the initial value is 0 (why?). with ui.refresh() this does
            // not happen.
            // Quick-fixed setting default knob value to NaN.
            qKnob.setValue("knobvalue", 0);
            volSlider.setValue("slidervalue", 0.5);
            pitchOnSwitch.setValue ("buttonvalue", 1);
            pitchDiscSwitch.setValue ("buttonvalue", 0);
            freqSwitch.setValue ("buttonvalue", 1);
            invertSwitch.setValue ("buttonvalue", 0);

            /* AUDIO INIT FUNCTION */
            function audioInit() {

                // AUDIO SOURCE INIT
                var audio = document.getElementById("a1"),
                    source = new AudioDataSource(audio),
                    shifterParams = {},
                    outputDestination = new AudioDataDestination();

                //Set auto latency.
                outputDestination.autoLatency = true;

                //The original signal must not be played back.
                audio.volume = 0;
                
                // END OF AUDIO SOURCE INIT

                // PITCH SHIFTER INIT

                shifterParams.fftFrameSize = 2048;
                shifterParams.shiftAmount = 1.0;
                shifterParams.osamp = 4;
                shifterParams.algo = "FFT";
                this.filter_shifter = new AudioDataShifterFilter (outputDestination, shifterParams);

                // END OF PITCH SHIFTER INIT

                source.readAsync(filter_shifter);
            }

            /* END OF AUDIO INIT FUNCTION */

        }

        /* --END */

        /*** CALLBACKS ***/

        /* LOADING MANAGER */

        function loadingManager (elementName) {
            // Closure persistent variables.
            var that = this,
                loadStatus = {
                    pitchKnob: false, freqKnob: false, qKnob: false,
                    background: false, volSlider: false,
                    pitchOnSwitch: false, pitchDiscSwitch : false,
                    freqSwitch: false, invertSwitch: false
                };

                // Actual callback
                return function (elementName) {
                    console.log (elementName, " called back to say everything is loaded.");

                    // Update the element status
                    if (loadStatus[elementName] !== undefined) {
                        loadStatus[elementName] = true;
                    }

                    // Check if every registered element is complete.
                    for (var element in loadStatus) {
                        if (loadStatus.hasOwnProperty(element)) {
                            if (loadStatus[element] !== true) {
                                console.log ("status of element ", element, " is not true: ", loadStatus[element]);
                                return;
                            }
                        }
                    }
                    console.log ("Everything loaded, time to keep on!");
                    that.keepON();
                }

        }
        /* END OF LOADING MANAGER */

        /* ELEMENT CALLBACKS */

        function pitchCallback () {
            var that = this;
            return function (slot, value) {
                // TODO: this interpolation should really not be linear.
                // LINEAR INTERPOLATION: x := (c - a) * (z - y) / (b - a) + y
                // c = value; a = 0; b = 1; y = 0.5; z = 2
                var shift_value = value * (1.5) + 0.5;
                that.filter_shifter.setShift(shift_value);
                console.log ("pitch callback finished: slot is ", slot, " and value is ", value, " while shifting ratio is ", shift_value);
            };
        }

        function freqCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("freq callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        function qCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("q callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        function volCallback () {
            var that = this;
            return function (slot, value) {
                console.log ("vol callback called: slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        function switchCallback () {
            var that = this;
            return function (slot, value, elName) {
                console.log ("switch callback called: element is ", elName, " slot is ", slot, " and value is ", value, " while that is ", that);
            };
        }

        /* END OF ELEMENT CALLBACKS */

        

    </script>
  </body>
</html>
